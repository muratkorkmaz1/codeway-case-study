
image: docker:latest

stages:

  - build
  - deploy_stage
  - deploy_prod

variables:
  # Docker Hub erişim bilgileri
  DOCKER_REGISTRY: "docker.io"
  DOCKER_IMAGE: "muratkorkmaz24/nodejs-express-mysql"
  HELM_CHART_DIR: "./helm-chart"  # Helm chart dosya yolu

  # Stage ortamı için Kubernetes bilgileri
  KUBE_CONTEXT_STAGE: "minikube"
  KUBE_NAMESPACE_STAGE: "nodejs-app-stage"
  ARGOCD_APP_NAME_STAGE: "nodejs-express-mysql"

  # Prod ortamı için Kubernetes bilgileri
  KUBE_CONTEXT_PROD: "minikube"
  KUBE_NAMESPACE_PROD: "nodejs-app"
  ARGOCD_APP_NAME_PROD: "nodejs-express-mysql-stage"

services:
  - name: docker:20.10.7-dind
    alias: docker

before_script:
  - docker info

# Build Docker image
build_image:
  stage: build
  script:
    - echo "Building Docker image"
    - docker build -t $DOCKER_REGISTRY/$DOCKER_IMAGE:$CI_COMMIT_SHA .
    - docker images 
    - docker tag $DOCKER_REGISTRY/$DOCKER_IMAGE:$CI_COMMIT_SHA $DOCKER_REGISTRY/$DOCKER_IMAGE:latest
    - docker images
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE:$CI_COMMIT_SHA
  only:
    - staging
    - main  # Hem staging hem de main branch'leri için geçerli


# Deploy to Kubernetes (Stage ortamı için)
deploy_stage:
  stage: deploy_stage
  script:
    - echo "Deploying to Kubernetes (Stage) using Helm"
    - helm upgrade --install nodejs-express-mysql-stage $HELM_CHART_DIR --namespace $KUBE_NAMESPACE_STAGE --set image.tag=$CI_COMMIT_SHA --kube-context $KUBE_CONTEXT_STAGE
  only:
    - staging  # Sadece staging branch'inde çalışacak

# Deploy to Kubernetes (Prod ortamı için)
deploy_prod:
  stage: deploy_prod
  script:
    - echo "Deploying to Kubernetes (Prod) using Helm"
    - helm upgrade --install nodejs-express-mysql $HELM_CHART_DIR --namespace $KUBE_NAMESPACE_PROD --set image.tag=$CI_COMMIT_SHA --kube-context $KUBE_CONTEXT_PROD
  only:
    - main  # Sadece main branch'inde çalışacak
